name: Parse Reviewed Event

on:
  issues:
    types: [labeled]

jobs:
  process-event:
    if: github.event.label.name == 'reviewed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse Issue and Create YAML
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;
            
            // Extract YAML block
            const yamlMatch = issueBody.match(/```yaml\n([\s\S]*?)\n```/);
            
            if (!yamlMatch) {
              console.log("No YAML code block found in issue body.");
              return;
            }
            
            const yamlContent = yamlMatch[1];
            
            // Validate basic structure (optional, but good practice)
            if (!yamlContent.includes('name:') || !yamlContent.includes('date-from:')) {
                 console.log("YAML content missing required fields.");
                 // Optionally comment on issue
                 await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: "Error: Could not parse event data. Ensure 'name' and 'date-from' are present."
                 });
                 return;
            }

            // Parse Name and Year for Filename
            const nameMatch = yamlContent.match(/name:\s*["']?([^"'\n\r]+)["']?/);
            const dateMatch = yamlContent.match(/date-from:\s*["']?(\d{4})/);

            let filename = `data/event-issue-${issueNumber}.yaml`; // Default fallback

            if (nameMatch && dateMatch) {
                const name = nameMatch[1].trim();
                const year = dateMatch[1];
                // Get first word, sanitize to alphanumeric
                const firstWord = name.split(/\s+/)[0].replace(/[^a-zA-Z0-9]/g, '');
                
                if (firstWord && year) {
                    filename = `data/${firstWord}_${year}.yaml`;
                }
            }

            const filePath = path.join(process.env.GITHUB_WORKSPACE, filename);
            
            // Check if file exists to avoid overwriting (optional safety, appends timestamp if needed)
            if (fs.existsSync(filePath)) {
                console.log(`File ${filename} already exists. Appending issue number.`);
                filename = filename.replace('.yaml', `_${issueNumber}.yaml`);
            }
            
            fs.writeFileSync(filePath, yamlContent);
            console.log(`Created file: ${filename}`);
            
            // Config Git
            await exec.exec('git', ['config', '--global', 'user.name', 'github-actions[bot]']);
            await exec.exec('git', ['config', '--global', 'user.email', 'github-actions[bot]@users.noreply.github.com']);
            
            // Commit and Push
            await exec.exec('git', ['add', filename]);
            await exec.exec('git', ['commit', '-m', `Add event from Issue #${issueNumber}`]);
            await exec.exec('git', ['push']);
            
            // Comment and Close
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `Event processed successfully! Created \`${filename}\`.`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });
